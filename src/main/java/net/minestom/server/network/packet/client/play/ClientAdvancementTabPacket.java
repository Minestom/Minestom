package net.minestom.server.network.packet.client.play;

import net.minestom.server.advancements.AdvancementAction;
import net.minestom.server.network.NetworkBuffer;
import net.minestom.server.network.packet.client.ClientPacket;
import org.jetbrains.annotations.Nullable;

import static net.minestom.server.network.NetworkBuffer.STRING;

public record ClientAdvancementTabPacket(AdvancementAction action,
                                         @Nullable String tabIdentifier) implements ClientPacket.Play {
    public static final NetworkBuffer.Type<ClientAdvancementTabPacket> SERIALIZER = new NetworkBuffer.Type<>() {
        static final NetworkBuffer.Type<AdvancementAction> ADVANCEMENT_ACTION_TYPE = NetworkBuffer.Enum(AdvancementAction.class);

        @Override
        public void write(NetworkBuffer buffer, ClientAdvancementTabPacket value) {
            buffer.write(ADVANCEMENT_ACTION_TYPE, value.action);
            if (value.action == AdvancementAction.OPENED_TAB) {
                assert value.tabIdentifier != null;
                buffer.write(STRING, value.tabIdentifier);
            }
        }

        @Override
        public ClientAdvancementTabPacket read(NetworkBuffer buffer) {
            var action = buffer.read(ADVANCEMENT_ACTION_TYPE);
            var tabIdentifier = action == AdvancementAction.OPENED_TAB ? buffer.read(STRING) : null;
            return new ClientAdvancementTabPacket(action, tabIdentifier);
        }
    };

    public ClientAdvancementTabPacket {
        if (tabIdentifier != null && tabIdentifier.length() > 256) {
            throw new IllegalArgumentException("Tab identifier too long: " + tabIdentifier.length());
        }
    }
}
